{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "e507d6ed_7fa6d8cf",
        "filename": "rust/Android.bp",
        "patchSetId": 1
      },
      "lineNbr": 93,
      "author": {
        "id": 1078119
      },
      "writtenOn": "2023-10-14T00:05:38Z",
      "side": 1,
      "message": "I had thought this would be useful to be able to selectively enable the Uuid feature, in particular for when this gets ported to out-of-tree bootloaders who may really want to minimize dependencies, but now I\u0027m not 100% convinced.\n\nIf we were using Cargo to build I think this would be easy since the end user can [select features for each dependency](https://doc.rust-lang.org/cargo/reference/specifying-dependencies.html#choosing-features) in their own `cargo.toml` file.\n\nBut as far as I can tell in Soong we need to pre-configure each build target with its own dependencies, which means we need separate targets for +uuid and -uuid (and it also scales horribly as we add more features).\n\nWDYT, should I just remove this feature selection and just force our users to depend on the uuid crate, or keep it optional?",
      "range": {
        "startLine": 93,
        "startChar": 0,
        "endLine": 93,
        "endChar": 27
      },
      "revId": "108549c26287d23f0349f673afbe9b48cfeb0e25",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "d7385248_50750bf5",
        "filename": "rust/Android.bp",
        "patchSetId": 1
      },
      "lineNbr": 93,
      "author": {
        "id": 1958315
      },
      "writtenOn": "2023-10-16T12:53:50Z",
      "side": 1,
      "message": "It\u0027s true that not all users may require the UUID feature, I agree that it is beneficial to keep it optional.",
      "parentUuid": "e507d6ed_7fa6d8cf",
      "range": {
        "startLine": 93,
        "startChar": 0,
        "endLine": 93,
        "endChar": 27
      },
      "revId": "108549c26287d23f0349f673afbe9b48cfeb0e25",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "69d414f1_5a182e21",
        "filename": "rust/Android.bp",
        "patchSetId": 1
      },
      "lineNbr": 106,
      "author": {
        "id": 1958315
      },
      "writtenOn": "2023-10-16T12:53:50Z",
      "side": 1,
      "message": "Can we merge this into `libavb_rs_nostd.defaults`? The following definition is also for `nostd`.",
      "range": {
        "startLine": 106,
        "startChar": 11,
        "endLine": 106,
        "endChar": 40
      },
      "revId": "108549c26287d23f0349f673afbe9b48cfeb0e25",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "4027174d_411e43f3",
        "filename": "rust/Android.bp",
        "patchSetId": 1
      },
      "lineNbr": 106,
      "author": {
        "id": 1078119
      },
      "writtenOn": "2023-10-16T23:55:53Z",
      "side": 1,
      "message": "That does seem to work thanks.",
      "parentUuid": "69d414f1_5a182e21",
      "range": {
        "startLine": 106,
        "startChar": 11,
        "endLine": 106,
        "endChar": 40
      },
      "revId": "108549c26287d23f0349f673afbe9b48cfeb0e25",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3d027cf4_09fc095e",
        "filename": "rust/src/verify.rs",
        "patchSetId": 1
      },
      "lineNbr": 617,
      "author": {
        "id": 1958315
      },
      "writtenOn": "2023-10-16T12:53:50Z",
      "side": 1,
      "message": "This is already imported in the header.\n\nSame for all the `c_char` below",
      "range": {
        "startLine": 617,
        "startChar": 22,
        "endLine": 617,
        "endChar": 39
      },
      "revId": "108549c26287d23f0349f673afbe9b48cfeb0e25",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "74d29803_126c7c09",
        "filename": "rust/src/verify.rs",
        "patchSetId": 1
      },
      "lineNbr": 617,
      "author": {
        "id": 1078119
      },
      "writtenOn": "2023-10-16T23:55:53Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "3d027cf4_09fc095e",
      "range": {
        "startLine": 617,
        "startChar": 22,
        "endLine": 617,
        "endChar": 39
      },
      "revId": "108549c26287d23f0349f673afbe9b48cfeb0e25",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0bb647ec_bca7adff",
        "filename": "rust/src/verify.rs",
        "patchSetId": 1
      },
      "lineNbr": 681,
      "author": {
        "id": 1958315
      },
      "writtenOn": "2023-10-16T12:53:50Z",
      "side": 1,
      "message": "Mm, I feel it is safer here to first convert the uuid to a `CString` or `CStr` then to bytes, rather than appending `\\0` directly. The first approach also enforces some checks on the input `\u0026str` to ensure that there\u0027s no invalid characters in the sequence.",
      "range": {
        "startLine": 681,
        "startChar": 0,
        "endLine": 681,
        "endChar": 24
      },
      "revId": "108549c26287d23f0349f673afbe9b48cfeb0e25",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "56c3e074_38ee7d9d",
        "filename": "rust/src/verify.rs",
        "patchSetId": 1
      },
      "lineNbr": 681,
      "author": {
        "id": 1078119
      },
      "writtenOn": "2023-10-16T23:55:53Z",
      "side": 1,
      "message": "The problem I\u0027m running into is that there is no API I can find that can convert the UUID to either `CString` or `CStr`. The only one I see is this [`encode_lower()`](https://docs.rs/uuid/latest/uuid/fmt/struct.Hyphenated.html#method.encode_lower) which always writes an unterminated string to an existing buffer, forcing us to terminate it manually for libavb.\n\nI tried using the `fmt` library to write into the buffer directly:\n\n```\nbuffer.write(\"{}\\0\", guid.as_hyphenated()).or(Err(IoError::Oom))?\n```\n\nbut it looks like the Write trait on `\u0026mut [u8]` is only available in `std`, I couldn\u0027t find any equivalent in `core`.",
      "parentUuid": "0bb647ec_bca7adff",
      "range": {
        "startLine": 681,
        "startChar": 0,
        "endLine": 681,
        "endChar": 24
      },
      "revId": "108549c26287d23f0349f673afbe9b48cfeb0e25",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e9dd2d3d_eb82081a",
        "filename": "rust/src/verify.rs",
        "patchSetId": 1
      },
      "lineNbr": 681,
      "author": {
        "id": 1958315
      },
      "writtenOn": "2023-10-17T12:54:54Z",
      "side": 1,
      "message": "What I actually meant is that we can do the following: first, we write the encoded string `\u0026str` to `Uuid::encode_buffer()`. Then, we can construct a `CString` by using `CString::new` and passing the buffer as an argument. Finally, we can copy the bytes from the CString to the buffer using `buffer.copy_from_slice(c_str.to_bytes())`.",
      "parentUuid": "56c3e074_38ee7d9d",
      "range": {
        "startLine": 681,
        "startChar": 0,
        "endLine": 681,
        "endChar": 24
      },
      "revId": "108549c26287d23f0349f673afbe9b48cfeb0e25",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "73239744_8200203e",
        "filename": "rust/src/verify.rs",
        "patchSetId": 1
      },
      "lineNbr": 681,
      "author": {
        "id": 1078119
      },
      "writtenOn": "2023-10-17T17:08:50Z",
      "side": 1,
      "message": "Ah gotcha, but `CString::new()` performs heap-allocation which we were trying to avoid in this lib - are you thinking it\u0027s worth heap-allocating here because it\u0027s only short-lived and we\u0027re going to free the memory once the data is copied into `buffer`?",
      "parentUuid": "e9dd2d3d_eb82081a",
      "range": {
        "startLine": 681,
        "startChar": 0,
        "endLine": 681,
        "endChar": 24
      },
      "revId": "108549c26287d23f0349f673afbe9b48cfeb0e25",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9a498758_2d5d7ac4",
        "filename": "rust/src/verify.rs",
        "patchSetId": 1
      },
      "lineNbr": 681,
      "author": {
        "id": 1958315
      },
      "writtenOn": "2023-10-18T08:00:30Z",
      "side": 1,
      "message": "Indeed, in this case, we do require heap allocation for `CString::new`. However, given that the `CString` is constructed from `Uuid::encode_buffer`, we can be certain that its length will not exceed 45 bytes. Considering the benefits of the checks it imposes, I think this small overhead of the heap allocation is worthwhile.",
      "parentUuid": "73239744_8200203e",
      "range": {
        "startLine": 681,
        "startChar": 0,
        "endLine": 681,
        "endChar": 24
      },
      "revId": "108549c26287d23f0349f673afbe9b48cfeb0e25",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9bb71c1f_c3925bfd",
        "filename": "rust/src/verify.rs",
        "patchSetId": 1
      },
      "lineNbr": 681,
      "author": {
        "id": 1078119
      },
      "writtenOn": "2023-10-18T16:54:22Z",
      "side": 1,
      "message": "Acknowledged",
      "parentUuid": "9a498758_2d5d7ac4",
      "range": {
        "startLine": 681,
        "startChar": 0,
        "endLine": 681,
        "endChar": 24
      },
      "revId": "108549c26287d23f0349f673afbe9b48cfeb0e25",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "a0d1e094_06815b4e",
        "filename": "rust/src/verify.rs",
        "patchSetId": 1
      },
      "lineNbr": 1023,
      "author": {
        "id": 1958315
      },
      "writtenOn": "2023-10-16T12:53:50Z",
      "side": 1,
      "message": "not related to this cl: In general, I think the current testing is a bit too low-level. This forces us to frequently adapt the tests when the implementation changes. Testing could be more efficient if we focus on testing behaviors rather than low-level implementation details.",
      "range": {
        "startLine": 1023,
        "startChar": 12,
        "endLine": 1023,
        "endChar": 25
      },
      "revId": "108549c26287d23f0349f673afbe9b48cfeb0e25",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ec11fd55_6f3c0cff",
        "filename": "rust/src/verify.rs",
        "patchSetId": 1
      },
      "lineNbr": 1023,
      "author": {
        "id": 1078119
      },
      "writtenOn": "2023-10-16T23:55:53Z",
      "side": 1,
      "message": "That\u0027s partially what I\u0027m trying to get at here re: behaviors rather than impl details - e.g. for this test here, I\u0027m aiming for the logic to be \"if we have a partition with these contents, then call this function, it should return these values\".\n\nWe\u0027ll get more end-to-end tests once we can actually do full verification runs against libavb which will be more high-level behavioral (e.g. given this kernel image and this vbmeta, verification should be successful) but even to do that we will need this test fixture to be fully functional and implement the callbacks properly, so it seems valuable to make sure the smaller pieces are behaving according to the libavb requirements as we go.\n\nCould you provide a quick example of what you\u0027re envisioning as a more behavioral test for these callbacks?",
      "parentUuid": "a0d1e094_06815b4e",
      "range": {
        "startLine": 1023,
        "startChar": 12,
        "endLine": 1023,
        "endChar": 25
      },
      "revId": "108549c26287d23f0349f673afbe9b48cfeb0e25",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "45d4ef2b_1f086a7d",
        "filename": "rust/src/verify.rs",
        "patchSetId": 1
      },
      "lineNbr": 1023,
      "author": {
        "id": 1958315
      },
      "writtenOn": "2023-10-17T12:54:54Z",
      "side": 1,
      "message": "I feel that these tests may be too low-level since we find ourselves needing to modify them frequently when introducing new features. Since each test only covers a small portion of the code (a single callback), I\u0027m uncertain if they can effectively detect significant regressions. Additionally, the effort required to maintain them seems quite high.\n\nIMHO, it would be preferable to prioritize testing the public API[1] and focusing on the user-observable behavior, we tested this way in pvmfw/avb[2]. However, it\u0027s possible that we can only adopt this approach once the library is complete.\n\n[1] http://engdoc/eng/doc/devguide/testing/unit/best-practices?polyglot\u003djava#public-apis\n[2] https://cs.android.com/android/platform/superproject/main/+/main:packages/modules/Virtualization/pvmfw/avb/tests/api_test.rs",
      "parentUuid": "ec11fd55_6f3c0cff",
      "range": {
        "startLine": 1023,
        "startChar": 12,
        "endLine": 1023,
        "endChar": 25
      },
      "revId": "108549c26287d23f0349f673afbe9b48cfeb0e25",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "8f00179b_31c7ca2f",
        "filename": "rust/src/verify.rs",
        "patchSetId": 1
      },
      "lineNbr": 1023,
      "author": {
        "id": 1078119
      },
      "writtenOn": "2023-10-17T17:08:50Z",
      "side": 1,
      "message": "Ack got it thanks for the links. Yeah once we have all the callbacks in place we will definitely be able to do tests that look more like [2] above but I don\u0027t think it\u0027s possible quite yet.",
      "parentUuid": "45d4ef2b_1f086a7d",
      "range": {
        "startLine": 1023,
        "startChar": 12,
        "endLine": 1023,
        "endChar": 25
      },
      "revId": "108549c26287d23f0349f673afbe9b48cfeb0e25",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}